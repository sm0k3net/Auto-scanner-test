const express = require('express');
const { exec } = require('child_process');
const config = require('../../config/config.json');
const axios = require('axios');
const router = express.Router();

router.post('/zap', async (req, res) => {
  const { url } = req.body;
  try {
    const scan = await axios.get(`${config.zapApi}/JSON/ascan/action/scan/?url=${encodeURIComponent(url)}`);
    res.json({ status: 'started', scanId: scan.data.scan });
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

router.post('/wpscan', async (req, res) => {
  const { url } = req.body;
  exec(`${config.wpscanPath} --url ${url} --no-update --format json`, (err, stdout, stderr) => {
    if (err) return res.status(500).json({ error: stderr });
    res.json({ result: JSON.parse(stdout) });
  });
});

router.post('/nmap-vuln', async (req, res) => {
  const { target } = req.body;
  exec(`${config.nmapPath} --script vuln ${target}`, (err, stdout, stderr) => {
    if (err) return res.status(500).json({ error: stderr });
    res.json({ result: stdout });
  });
});

router.post('/virustotal', async (req, res) => {
  const { url } = req.body;
  try {
    const resp = await axios.post(
      'https://www.virustotal.com/api/v3/urls',
      `url=${encodeURIComponent(url)}`,
      { headers: { 'x-apikey': config.virustotalApiKey, 'content-type': 'application/x-www-form-urlencoded' } }
    );
    res.json(resp.data);
  } catch (e) {
    res.status(500).json({ error: e.message });
  }
});

module.exports = router;